name: Sync Release

on:
  workflow_dispatch:
    inputs:
      release_branch:
        description: "Release branch to receive changes from master"
        required: true
        type: string

jobs:
  create-sync-pr:
    name: Create sync pull request
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    env:
      RELEASE_BRANCH: ${{ inputs.release_branch }}
    steps:
      - name: Validate input
        run: |
          if [ -z "${RELEASE_BRANCH}" ]; then
            echo "release_branch input is required"
            exit 1
          fi
      - name: Create or reuse PR
        uses: actions/github-script@v7
        env:
          RELEASE_BRANCH: ${{ inputs.release_branch }}
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const releaseBranch = process.env.RELEASE_BRANCH;
            const headBranch = "master";
            const {owner, repo} = context.repo;

            // Ensure release branch exists
            try {
              await github.rest.repos.getBranch({
                owner,
                repo,
                branch: releaseBranch,
              });
            } catch (error) {
              core.setFailed(`Release branch "${releaseBranch}" not found.`);
              return;
            }

            // Prevent duplicate open PRs
            const existing = await github.rest.pulls.list({
              owner,
              repo,
              state: "open",
              head: `${owner}:${headBranch}`,
              base: releaseBranch,
            });

            if (existing.data.length) {
              const pr = existing.data[0];
              core.notice(`PR already exists: ${pr.html_url}`);
              core.setOutput("pr-url", pr.html_url);
              return;
            }

            const title = `Sync ${releaseBranch}`;
            const body = [
              `Automated PR to sync master into ${releaseBranch}.`,
              "",
              `Triggered by @${context.actor}.`,
            ].join("\n");

            const pr = await github.rest.pulls.create({
              owner,
              repo,
              head: headBranch,
              base: releaseBranch,
              title,
              body,
            });

            core.setOutput("pr-url", pr.html_url);
            core.notice(`Created PR ${pr.html_url}`);
